name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  ACT: ''

jobs:
  test-linux:
    name: Test Linux (${{ matrix.container }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container: ['ubuntu:24.04', 'fedora:42']
    container:
      image: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies (Ubuntu)
        if: startsWith(matrix.container, 'ubuntu')
        run: |
          apt-get update
          apt-get install -y \
            build-essential pkg-config \
            curl git \
            clang libclang-dev \
            libwayland-dev \
            libx11-dev libxcb1-dev libx11-xcb-dev \
            libxcb-randr0-dev libxcb-shm0-dev libxcb-xfixes0-dev \
            libdrm-dev libgbm-dev libegl1-mesa-dev \
            libsecret-1-dev \
            libpipewire-0.3-dev \
            xvfb \
            openbox

      - name: Install Dependencies (Fedora)
        if: startsWith(matrix.container, 'fedora')
        run: |
          dnf install -y \
            gcc gcc-c++ make pkg-config \
            curl git \
            clang clang-devel \
            wayland-devel \
            libX11-devel libxcb-devel \
            libdrm-devel mesa-libgbm-devel mesa-libEGL-devel \
            libsecret-devel \
            pipewire-devel

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: rustfmt, clippy, llvm-tools-preview

      - name: Rust cache
        if: ${{ !env.ACT }}  # Skipped in act (container jobs lack Node.js)
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        if: ${{ !env.ACT }}  # Skipped in act (container jobs lack Node.js)
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests (with coverage)
        if: ${{ !env.ACT }}
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Run tests
        if: ${{ env.ACT }}
        run: cargo test --all-features --workspace

      - name: Run X11 integration tests (headless)
        if: startsWith(matrix.container, 'ubuntu')
        run: |
          # Start Xvfb with a virtual display
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 1
          export DISPLAY=:99
          # Start openbox window manager (provides _NET_CLIENT_LIST for window enumeration)
          openbox &
          sleep 1
          # Run the tests
          cargo test --test x11_integration_tests -p screenshot-core --all-features

      - name: Upload coverage to Codecov
        if: ${{ !env.ACT }}  # Skipped in act (container jobs lack Node.js)
        uses: codecov/codecov-action@v3
        with:
          files: lcov.info
          fail_ci_if_error: false

      - name: Check Documentation
        run: cargo doc --no-deps --document-private-items

  test-windows:
    name: Test Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          components: rustfmt, clippy

      - name: Rust cache
        if: ${{ !env.ACT }}  # Skipped in act (unsupported platform)
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all-features

  # macOS deferred until M5
  # test-macos:
  #   name: Test macOS
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Run tests
  #       run: cargo test --all-features
